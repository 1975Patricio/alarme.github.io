<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despertador Web Visual com Notificações</title>
    
    <!-- Configurações PWA e Service Worker (necessário para notificações) -->
    <link rel="manifest" href="manifest.json">
    <script>
        // Função para registar o Service Worker assim que a página carrega
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                    console.log('Service Worker registado com sucesso:', registration.scope);
                }, function(err) {
                    console.log('Falha ao registar Service Worker:', err);
                });
            });
        }
    </script>
    
    <!-- Estilo CSS integrado -->
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            font-family: sans-serif;
            transition: background-color 0.1s ease;
            cursor: pointer;
        }

        .wrapper { /* ... (restante do CSS do wrapper, controls, etc. - é o mesmo de antes) ... */ }
        .alarm-active-hide { display: none !important; }
        /* Adicione o restante CSS da resposta anterior aqui */
        .wrapper { text-align: center; padding: 20px; background-color: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 300px; z-index: 10; }
        .display { font-size: 3rem; margin-bottom: 15px; color: #333; }
        .controls input, .controls button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
        #setAlarm { background-color: #4CAF50; color: white; cursor: pointer; }
        #stopAllAlarmsBtn { background-color: #f44336; color: white; cursor: pointer; margin-top: 15px; }
        #alarmList { margin-top: 20px; text-align: left; list-style-type: none; padding: 0; }
        .alarmItem { display: flex; justify-content: space-between; align-items: center; padding: 8px; background-color: #e9e9e9; margin-bottom: 5px; border-radius: 4px; }
        .deleteAlarm { background-color: #ff0000; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
    </style>
</head>
<body onclick="stopAllAlarms()">
    <div class="wrapper" id="wrapper">
        <h1>Despertador</h1>
        <button onclick="requestNotificationPermission()">Ativar Notificações</button>
        <div class="display" id="clock"></div>
        
        <!-- ... (Resto do HTML para inputs e lista de alarmes) ... -->
        <div class="controls">
            <input type="time" id="alarmTime">
            <button id="setAlarm">Adicionar Alarme</button>
        </div>
        <h2>Alarmes Ativos</h2>
        <ul id="alarmList"></ul>
        <button id="stopAllAlarmsBtn">Parar Animação/Som</button>
    </div>

    <!-- Script JavaScript integrado -->
    <script>
        // ... (As suas variáveis e funções updateTime, checkAlarms, getRandomColor, startColorChange, addAlarm, deleteAlarm, renderAlarms, setInterval(updateTime, 1000), event listeners) ...
        // Código JavaScript completo abaixo, com a nova função requestNotificationPermission e sendNotification

        const clockDisplay = document.getElementById('clock');
        const alarmTimeInput = document.getElementById('alarmTime');
        const setAlarmButton = document.getElementById('setAlarm');
        const stopAllAlarmsButton = document.getElementById('stopAllAlarmsBtn');
        const alarmList = document.getElementById('alarmList');
        const body = document.body;
        const wrapper = document.getElementById('wrapper');
        
        let alarms = [];
        let isAlarmRinging = false;
        let colorInterval;

        // --- Novas Funções de Notificação ---
        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    alert('Permissão de notificação concedida. O alarme pode agora notificar em segundo plano.');
                } else {
                    alert('Permissão de notificação negada. O alarme só funcionará com a página aberta.');
                }
            });
        }

        function sendNotification(time) {
            if (Notification.permission === 'granted') {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification('Hora do Alarme!', {
                        body: O alarme das ${time} está a tocar! Toque aqui para abrir a página.,
                        icon: 'icon-192x192.png', // Opcional: Caminho para um ícone
                        vibrate: [200, 100, 200]
                    });
                });
            }
        }
        // ------------------------------------

        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const currentTimeString = ${hours}:${minutes}:${seconds};
            clockDisplay.textContent = currentTimeString;

            if (!isAlarmRinging) {
                checkAlarms(${hours}:${minutes});
            }
        }

        function checkAlarms(currentTime) {
            alarms.forEach(alarm => {
                if (alarm.time === currentTime && !alarm.triggered) {
                    triggerAlarm(alarm.id, currentTime); // Passa a hora para a notificação
                }
            });
        }

        function triggerAlarm(alarmId, time) {
            if (isAlarmRinging) return;

            // Envia a notificação Push para o Android
            sendNotification(time);

            isAlarmRinging = true;
            wrapper.classList.add('alarm-active-hide');
            startColorChange();

            const triggeredAlarm = alarms.find(a => a.id === alarmId);
            if (triggeredAlarm) {
                triggeredAlarm.triggered = true;
            }
        }
        
        // ... (Resto das funções auxiliares: getRandomColor, startColorChange, stopAllAlarms, addAlarm, deleteAlarm, renderAlarms) ...
        function getRandomColor() { /* ... */ }
        function startColorChange() {
            body.style.backgroundColor = getRandomColor();
            colorInterval = setInterval(() => {
                body.style.backgroundColor = getRandomColor();
            }, 150);
        }
        function stopAllAlarms() {
            if (!isAlarmRinging) return;
            isAlarmRinging = false;
            clearInterval(colorInterval);
            body.style.backgroundColor = '#f0f0f0';
            wrapper.classList.remove('alarm-active-hide');
        }
        function addAlarm() { /* ... */ }
        function deleteAlarm(id) { /* ... */ }
        function renderAlarms() { /* ... */ }

        setInterval(updateTime, 1000);
        setAlarmButton.addEventListener('click', addAlarm);
        stopAllAlarmsButton.addEventListener('click', stopAllAlarms);
        updateTime();
    </script>
</body>
</html>
